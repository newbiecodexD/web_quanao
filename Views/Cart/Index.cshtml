@model IEnumerable<web_quanao.Models.CartItem>
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_LayoutCart.cshtml";
    var total = ViewBag.Total as decimal? ?? 0m;
}
<style>.cart-table th,.cart-table td{vertical-align:middle}.qty-input{width:70px;text-align:center</style>
<h2 class="mb-3">Giỏ hàng của bạn</h2>
@if (!Model.Any()){
    <div class="alert alert-info">Giỏ hàng trống. <a href="@Url.Action("Index","Home")">Tiếp tục mua sắm</a>.</div>
} else {
    @Html.AntiForgeryToken()
    <table class="table table-bordered cart-table">
        <thead class="table-light"><tr><th>Sản phẩm</th><th class="text-end" style="width:140px;">Đơn giá</th><th class="text-center" style="width:120px;">Số lượng</th><th class="text-end" style="width:160px;">Thành tiền</th><th style="width:80px;">Xóa</th></tr></thead>
        <tbody>
        @foreach (var it in Model){
            <tr data-id="@it.idPro">
                <td>@it.namePro</td>
                <td class="text-end unit-price" data-price="@it.price">@String.Format("{0:N0}đ", it.price)</td>
                <td class="text-center"><input type="number" min="1" class="form-control qty-input" value="@it.quantity" /></td>
                <td class="text-end line-total">@String.Format("{0:N0}đ", it.total)</td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger btn-remove">Xóa</button></td>
            </tr>
        }
        </tbody>
        <tfoot><tr><th colspan="3" class="text-end">Tổng</th><th class="text-end" id="grandTotal">@String.Format("{0:N0}đ", total)</th><th></th></tr></tfoot>
    </table>
    <div class="d-flex justify-content-between align-items-center">
        <div class="btn-group">
            <a href="@Url.Action("Index","Home")" class="btn btn-outline-secondary">Tiếp tục mua sắm</a>
            <button type="button" id="btnClear" class="btn btn-outline-danger">Xóa hết</button>
        </div>
        <a href="@Url.Action("Checkout","Cart")" class="btn btn-primary" data-loading>Thanh toán</a>
    </div>
}
@section scripts{
<script>
(function(){
    function fmt(v){return (v||0).toLocaleString('vi-VN')+'đ';}
    function recalc(){var total=0; $('tbody tr').each(function(){var $tr=$(this); var price=parseInt($tr.find('.unit-price').data('price'))||0; var qty=parseInt($tr.find('.qty-input').val())||1; if(qty<1) qty=1; var line=price*qty; total+=line; $tr.find('.line-total').text(fmt(line));}); $('#grandTotal').text(fmt(total)); window.UpdateCartBadge && window.UpdateCartBadge(); }
    $(document).on('change','.qty-input',function(){var $tr=$(this).closest('tr'); var id=$tr.data('id'); var qty=parseInt($(this).val())||1; if(qty<1) qty=1; $(this).val(qty); var token=$('input[name="__RequestVerificationToken"]').val(); $.post('@Url.Action("UpdateAjax","Cart")',{ __RequestVerificationToken:token, id:id, quantity:qty },function(r){ if(r&&r.success){ $tr.find('.line-total').text(fmt(parseInt($tr.find('.unit-price').data('price'))*qty)); $('#grandTotal').text(fmt(r.total)); window.UpdateCartBadge && window.UpdateCartBadge(); } }); });
    $(document).on('click','.btn-remove',function(){ if(!confirm('Xóa sản phẩm này khỏi giỏ?')) return; var $tr=$(this).closest('tr'); var id=$tr.data('id'); var token=$('input[name="__RequestVerificationToken"]').val(); $.post('@Url.Action("RemoveAjax","Cart")',{ __RequestVerificationToken:token, id:id },function(r){ if(r&&r.success){ $tr.remove(); $('#grandTotal').text(fmt(r.total)); if($('tbody tr').length==0) location.reload(); window.UpdateCartBadge && window.UpdateCartBadge(); } }); });
    $('#btnClear').on('click',function(){ if(!confirm('Xóa tất cả sản phẩm trong giỏ?')) return; var token=$('input[name="__RequestVerificationToken"]').val(); $.post('@Url.Action("ClearAjax","Cart")',{ __RequestVerificationToken:token },function(r){ if(r&&r.success){ $('tbody').empty(); $('#grandTotal').text(fmt(0)); location.reload(); } }); });
})();
</script>
}
