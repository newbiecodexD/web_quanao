<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - UNIQLO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { display:flex; flex-direction:column; min-height:100vh; font-family:Arial, sans-serif; background-color:#f7f7f7; }
        .page-container { flex:1; display:flex; flex-direction:column; }
        .top-container { display:grid; grid-template-columns:200px 1fr auto; align-items:center; padding:.5rem 2rem; border-bottom:1px solid #e0e0e0; background:#fff; position:sticky; top:0; z-index:1020; }
        .logo-brand { display:flex; align-items:center; text-decoration:none; color:#000; }
        .logo-brand img { height:35px; margin-right:12px; }
        .logo-brand span { font-size:1.6rem; font-weight:bold; text-transform:uppercase; letter-spacing:-1px; }
        .main-menu ul { list-style:none; margin:0; padding:0; display:flex; justify-content:center; align-items:center; gap:2rem; }
        .main-menu a { text-decoration:none; color:#333; font-weight:600; font-size:.9rem; padding:.5rem 0; border-bottom:2px solid transparent; transition:border-color .3s; }
        .main-menu a:hover { border-color:#da291c; }
        .right-contact { display:flex; align-items:center; justify-content:flex-end; gap:1.2rem; }
        .right-contact .nav-link { font-size:1.4rem; color:#333; transition:color .2s; padding:0; }
        .right-contact .nav-link:hover { color:#da291c; }
        .dropdown-menu { min-width:220px; }
        .main-layout-container { display:flex; flex:1; padding:2rem; gap:2rem; }
        .left-menu { flex-basis:220px; flex-shrink:0; background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.05); height:fit-content; }
        .main-content { flex-grow:1; background:#fff; padding:2rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.05); }
        footer { text-align:center; padding:1.5rem; background:#343a40; color:#fff; margin-top:auto; }
        .toast-container{ position:fixed; top:1rem; right:1rem; z-index:2000; }
    </style>
    @RenderSection("Styles", required:false)
</head>
<body>
    @using Microsoft.AspNet.Identity

    <div class="page-container">
        <header class="top-container">
            <a href="@Url.Action("Index","Home")" class="logo-brand">
                <img src="~/Content/Images/uniqlo-logo.png" alt="Uniqlo Logo" />
                <span>UNIQLO</span>
            </a>

            <nav class="main-menu">
                <ul>
                    <li><a href="@Url.Action("Index","Home")">Trang Chủ</a></li>
                    <li><a href="@Url.Action("MenClothes", "Home")">Nam</a></li>
                    <li><a href="@Url.Action("WomenClothes", "Home")">Nữ</a></li>
                    <li><a href="@Url.Action("KidsClothes", "Home")">Trẻ Em</a></li>
                </ul>
            </nav>

            <div class="right-contact">
                @if (Request.IsAuthenticated)
                {
                    <ul class="navbar-nav d-flex flex-row align-items-center">
                        <li class="nav-item">
                            <a href="@Url.Action("Index","Cart")" class="nav-link position-relative" title="Giỏ hàng">
                                <i class="bi bi-cart"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Tài khoản">
                                <i class="bi bi-person-circle"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <span class="dropdown-item disabled text-muted" title="@User.Identity.GetUserName()">
                                        <i class="bi bi-person me-2"></i>
                                        Xin chào @User.Identity.GetUserName()!
                                    </span>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a href="@Url.Action("Index", "Manage")" class="dropdown-item" title="Quản lý tài khoản">
                                        <i class="bi bi-gear me-2"></i>
                                        Quản lý tài khoản
                                    </a>
                                </li>
                                <li>
                                    @using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <a class="dropdown-item" href="javascript:document.getElementById('logoutForm').submit()" title="Đăng xuất">
                                            <i class="bi bi-box-arrow-right me-2"></i>
                                            Đăng xuất
                                        </a>
                                    }
                                </li>
                            </ul>
                        </li>
                    </ul>
                }
                else
                {
                    <ul class="navbar-nav d-flex flex-row align-items-center">
                        <li class="nav-item">
                            <a href="@Url.Action("Register", "Account")" id="registerLink" class="nav-link" title="Đăng ký">
                                <i class="bi bi-person-plus"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="@Url.Action("Login", "Account")" id="loginLink" class="nav-link" title="Đăng nhập">
                                <i class="bi bi-box-arrow-in-right"></i>
                            </a>
                        </li>
                    </ul>
                }
            </div>
        </header>

        @RenderSection("Banner", required:false)
        @RenderSection("Slideshow", required:false)

        <main class="main-layout-container">
            <aside class="left-menu">
                @RenderSection("LeftFilter", required:false)
            </aside>

            <div class="main-content">
                @RenderBody()
            </div>
        </main>
    </div>

    <div class="toast-container"></div>

    <footer><p>&copy; @DateTime.Now.Year - UNIQLO</p></footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    @using (Html.BeginForm("","",FormMethod.Post, new { id = "__AjaxAntiForgeryForm" })) { @Html.AntiForgeryToken() }

    <script>
    (function(){
        function getToken(){ var el = document.querySelector('#__AjaxAntiForgeryForm input[name="__RequestVerificationToken"]'); return el ? el.value : ''; }
        function showToast(msg){
            var id = 't' + Date.now();
            var html = '<div id="'+id+'" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">'
                +'<div class="d-flex"><div class="toast-body">'+ msg +'</div>'
                +'<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>';
            var $c = $('.toast-container'); $c.append(html);
            var toastEl = document.getElementById(id); var t = new bootstrap.Toast(toastEl, { delay: 1600 }); t.show(); t._element.addEventListener('hidden.bs.toast', function(){ $(toastEl).remove(); });
        }
        function getCart(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch(e){ return []; } }
        function saveCart(c){ try{ localStorage.setItem('cart', JSON.stringify(c)); }catch(e){} }
        function updateBadge(){
            // Ưu tiên lấy số lượng từ server nếu đã đăng nhập để đồng bộ DB cart
            if(@User.Identity.IsAuthenticated.ToString().ToLower()){
                $.ajax({ url: '@Url.Action("SyncLocal","Cart")', method:'POST', headers:{ 'RequestVerificationToken': getToken() }, data: JSON.stringify([]), contentType:'application/json; charset=utf-8' })
                 .always(function(){ // sau sync rỗng vẫn cập nhật từ local để hiển thị tức thì
                    var c = getCart(); var cnt = 0; c.forEach(function(x){ cnt += x.qty||0; }); $('.cart-count').text(cnt);
                 });
            } else {
                var c = getCart(); var cnt = 0; c.forEach(function(x){ cnt += x.qty||0; }); $('.cart-count').text(cnt);
            }
        }
        // Gọi sync sau đăng nhập: nếu đã đăng nhập và còn dữ liệu localStorage thì đẩy lên DB rồi xóa
        function syncAfterLogin(){
            if(!@User.Identity.IsAuthenticated.ToString().ToLower()) return;
            var cart = getCart(); if(!cart.length) { updateBadge(); return; }
            $.ajax({
                url: '@Url.Action("SyncLocal","Cart")',
                method: 'POST',
                headers: { 'RequestVerificationToken': getToken() },
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(cart.map(function(x){ return { ProductId:x.id, Quantity:x.qty }; })),
                success: function(res){ if(res && res.success){ try{ localStorage.removeItem('cart'); }catch(e){} $('.cart-count').text(res.count||0); } },
                complete: function(){ updateBadge(); }
            });
        }

        $(document).on('click', '.add-to-cart', function(e){
            e.preventDefault();
            var $btn = $(this);
            var pid = parseInt($btn.data('productid'))||0;
            var name = $btn.data('name') || ($btn.closest('.card').find('.card-title').text().trim());
            var price = parseInt($btn.data('price'))||0;
            if(!pid){ return; }
            var cart = getCart();
            var ex = cart.find(function(x){ return x.id === pid; });
            if(ex){ ex.qty += 1; }
            else{ cart.push({ id: pid, name: name, price: price, qty: 1 }); }
            saveCart(cart);
            showToast('Đã thêm "' + name + '" vào giỏ hàng');
            updateBadge();
        });

        // Khởi tạo: sync nếu đã login rồi làm mới badge
        $(function(){ syncAfterLogin(); });
    })();
    </script>

    @RenderSection("Scripts", required:false)
</body>
</html>